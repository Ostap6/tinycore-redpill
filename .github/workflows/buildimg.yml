name: buildimg

on:
  workflow_dispatch:
    inputs:
      model:
        description: 'model'
        required: true
        default: 'DS3622xs+'
      revision:
        description: 'revision'
        required: true
        default: '7.2.2-72806'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: build tinycore-redpill loader with lastest img
        id: build-loader
        run: |
          sudo apt update
          sudo apt-get install pciutils qemu-utils cpio kmod ncurses-bin

          sudo mkdir /home/tc
          sudo mkdir /opt/output
          sudo cp -rf ./* /home/tc
          ls -ltr /home/tc
          
          LATESTURL="`curl --connect-timeout 5 -skL -w %{url_effective} -o /dev/null "https://github.com/PeterSuh-Q3/tinycore-redpill/releases/latest"`"
          TAG="${LATESTURL##*/}"
          echo "TAG is ${TAG}"
          curl -kLO# https://github.com/PeterSuh-Q3/tinycore-redpill/releases/download/${TAG}/tinycore-redpill.${TAG}.m-shell.img.gz
          gunzip tinycore-redpill.${TAG}.m-shell.img.gz          
          pwd
          ls -ltr
          echo "::set-output name=TAG::${TAG}"

          path=`pwd`

          LOOPX=$(sudo losetup -f)
          sudo losetup -P ${LOOPX} tinycore-redpill.${TAG}.m-shell.img
          sudo fdisk -l ${LOOPX}

          loaderdisk=$(echo ${LOOPX} | cut -c 6-12 )

          sudo mkdir -p /mnt/${loaderdisk}p1
          sudo mkdir -p /mnt/${loaderdisk}p2
          sudo mkdir -p /mnt/${loaderdisk}p3

          sudo mount ${LOOPX}p1 /mnt/${loaderdisk}p1
          sudo mount ${LOOPX}p2 /mnt/${loaderdisk}p2
          sudo mount ${LOOPX}p3 /mnt/${loaderdisk}p3

          ls -ltr /mnt/${loaderdisk}p1
          ls -ltr /mnt/${loaderdisk}p2
          ls -ltr /mnt/${loaderdisk}p3

          cd /home/tc
          sudo ./functions.sh ${{github.event.inputs.model}}-${{github.event.inputs.revision}} noconfig fri

          sudo losetup -d ${LOOPX}

          cd ${path}
          gzip -c tinycore-redpill.${TAG}.m-shell.img > /opt/output/tinycore-redpill.${TAG}.m-shell.img.gz

          qemu-img convert -f raw -O vmdk tinycore-redpill.${TAG}.m-shell.img tinycore-redpill.${TAG}.m-shell.vmdk
          gzip -c tinycore-redpill.${TAG}.m-shell.vmdk > /opt/output/tinycore-redpill.${TAG}.m-shell.vmdk.gz
          
          ls -ltr /opt/output
          
      - name: Upload MshellImage-${{ steps.build-loader.outputs.TAG }}-${{github.event.inputs.model}}-${{github.event.inputs.revision}}
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: MshellImage-${{ steps.build-loader.outputs.TAG }}-${{github.event.inputs.model}}-${{github.event.inputs.revision}}
          path: /opt/output
